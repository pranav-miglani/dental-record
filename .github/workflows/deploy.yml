name: Deploy to AWS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
      - 'src/**'
      - 'scripts/**'
      - '.github/workflows/deploy.yml'

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  PROJECT_NAME: ${{ secrets.PROJECT_NAME || 'dental-hospital-system' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}

jobs:
  deploy:
    name: Deploy Infrastructure and Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Load configuration from secrets
        run: |
          # Export all secrets as environment variables
          export AWS_REGION="${{ secrets.AWS_REGION || 'us-east-1' }}"
          export PROJECT_NAME="${{ secrets.PROJECT_NAME || 'dental-hospital-system' }}"
          export ENVIRONMENT="${{ env.ENVIRONMENT }}"
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          export TERRAFORM_STATE_BUCKET="${{ secrets.TERRAFORM_STATE_BUCKET }}"
          export API_CUSTOM_DOMAIN="${{ secrets.API_CUSTOM_DOMAIN }}"
          export ROUTE53_HOSTED_ZONE_ID="${{ secrets.ROUTE53_HOSTED_ZONE_ID }}"
          export ACM_CERTIFICATE_ARN="${{ secrets.ACM_CERTIFICATE_ARN }}"
          export CLOUDFRONT_CUSTOM_DOMAIN="${{ secrets.CLOUDFRONT_CUSTOM_DOMAIN }}"
          export CLOUDFRONT_ROUTE53_ZONE_ID="${{ secrets.CLOUDFRONT_ROUTE53_ZONE_ID }}"
          export CLOUDFRONT_ACM_CERTIFICATE_ARN="${{ secrets.CLOUDFRONT_ACM_CERTIFICATE_ARN }}"
          
          # Save to .env for deploy script compatibility
          cat > .env << EOF
          AWS_REGION=$AWS_REGION
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          PROJECT_NAME=$PROJECT_NAME
          ENVIRONMENT=$ENVIRONMENT
          JWT_SECRET=$JWT_SECRET
          ADMIN_PASSWORD=$ADMIN_PASSWORD
          TERRAFORM_STATE_BUCKET=$TERRAFORM_STATE_BUCKET
          API_CUSTOM_DOMAIN=$API_CUSTOM_DOMAIN
          ROUTE53_HOSTED_ZONE_ID=$ROUTE53_HOSTED_ZONE_ID
          ACM_CERTIFICATE_ARN=$ACM_CERTIFICATE_ARN
          CLOUDFRONT_CUSTOM_DOMAIN=$CLOUDFRONT_CUSTOM_DOMAIN
          CLOUDFRONT_ROUTE53_ZONE_ID=$CLOUDFRONT_ROUTE53_ZONE_ID
          CLOUDFRONT_ACM_CERTIFICATE_ARN=$CLOUDFRONT_ACM_CERTIFICATE_ARN
          EOF

      - name: Install dependencies
        run: npm ci

      - name: Run deployment
        run: |
          chmod +x scripts/deploy-all.sh
          ./scripts/deploy-all.sh --skip-admin
        env:
          GITHUB_ACTIONS: true

      - name: Save deployment outputs
        if: success()
        run: |
          echo "API_URL=$(cat api-url.txt 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "Deployment completed successfully" >> $GITHUB_STEP_SUMMARY

      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f api-url.txt ]; then
            echo "**API URL:** $(cat api-url.txt)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
